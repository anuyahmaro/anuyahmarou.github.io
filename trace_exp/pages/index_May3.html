<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Trace</title>
    <!--Import Google Icon Font-->
    <!--<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">-->
    <!--Import materialize.css-->
    <!--<link rel="stylesheet" href="../static/css/materialize.min.css">-->
    <script type="text/javascript" src="https://code.jquery.com/jquery-2.2.1.min.js"></script>
    <script src="https://cdn.rawgit.com/Dogfalo/materialize/fc44c862/dist/js/materialize.min.js"></script>
    <script type="text/javascript" src="../static/js/pagination.js"></script>

    <!--<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>-->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <link rel="stylesheet" type="text/css" href="../static/css/myStyles2.css" />

</head>

<body class = 'blue-grey lighten-5' >


<div class="row">
    <div class = "artifact-panels col s12">

        <div class="content-panel col s4">
            <div  class="art_contents content-panel-style" style="background-color: white">
                <a id="source_art_name" style="margin-top: -18px" class="waves-effect waves-light blue-grey lighten-4 dim-grey-text btn-small artifact-type disabled">Source Artifact</a>
                <!--<a id="source_art_type" style="margin-top: -18px" class="btn btn-small type_btn tooltip_ score-btn" style="background-color: white; cursor: unset; box-shadow: none; color: black;">Source Artifact</a>-->
                <button type="button" class="btn btn-small type_btn tooltip_" style="margin-top: -18px; background-color: white; cursor: unset; box-shadow: none; color: black; font-size: 1em"><b>Type: </b> <span id="source_type"></span><span class="tooltiptext_" id="source_type_text" style="text-transform: capitalize"></span></button>

                <p id = "source_artifact">

                </p>

            </div>
        </div>

        <div class="relationship-panel  col s3">
            <div class="information-panel">
                <div class="information-panel-content" id = "relationship_update" > </div>
            </div>
            <!--<br>-->
            <div id="tree"></div>



        </div>






        <!--<div id="tree"></div><div id = "source_artifact" class="art_contents content-panel-style">-->
        <div class="content-panel col s5"  >
            <div class="content-panel-style2 " style="margin-top: 10px; margin-left: 0px; overflow: scroll">
                <table cellpadding="1" cellspacing="1" class="table table-hover" id="myTable">
                    <colgroup>
                        <col span="1" style="width: 75%;">
                        <col span="1" style="width: 25%;">
                    </colgroup>
                </table>

                <div class="col-md-12 center text-center" id="pagination_panel">
                    <span class="left" id="total_reg" style="color: black; background-color: whitesmoke; padding: 4px"></span>
                    <ul class="pagination pager" style="text-align: center" id="myPager"></ul>
                </div>
            </div>



        </div>





    </div>
</div>

<!--<a class="waves-effect waves-light btn modal-trigger" id="modal1_fire" href="#modal1">Modal</a>-->
<div id="modal1" class="modal" style="display: none">
    <div class="modal-content">
        <h5 style="text-align: center">Vetting Details</h5>
        <table>
            <tr>
                <th>Date</th>
                <th>Name</th>
                <th>Role</th>
                <th>Link correct?</th>
            </tr>
            <tr>
                <td>11/06/19</td>
                <td>J Cleland-Huang</td>
                <td>Software Engr</td>
                <td>Yes</td>
            </tr>
            <tr>
                <td>12/06/19</td>
                <td>Y Liu</td>
                <td>Safety Analyst</td>
                <td>No</td>
            </tr>


        </table>
    </div>
    <div style="text-align: center">
        <!--<h6>Do you agree that this is a link?</h6>-->
        <a href="#!" class="modal-close waves-effect waves-green btn-flat">Close</a>
    </div>
</div>

<div id="modal2" class="modal">
    <div class="modal-content">
        <h5 style="text-align: center">Vetting Details</h5>
        <table>
            <tr>
                <th>Date</th>
                <th>Name</th>
                <th>Role</th>
                <th>Link correct?</th>
            </tr>
            <tr>
                <td>01/02/20</td>
                <td>N Farrell</td>
                <td>Researcher</td>
                <td>No</td>
            </tr>
            <tr>
                <td>01/10/20</td>
                <td>G Rovelli</td>
                <td>Software Engr</td>
                <td>Yes</td>
            </tr>
        </table>
    </div>
    <div style="text-align: center">
        <!--<h6>Do you agree that this is a link?</h6>-->
        <a href="#!" class="modal-close waves-effect waves-green btn-flat">Close</a>
    </div>
</div>

<div id="modal3" class="modal">
    <div class="modal-content">
        <h5 style="text-align: center">Vetting Details</h5>
        <table>
            <tr>
                <th>Date</th>
                <th>Name</th>
                <th>Role</th>
                <th>Link correct?</th>
            </tr>
            <tr>
                <td>11/06/19</td>
                <td>J Cleland-Huang</td>
                <td>Software Engr</td>
                <td>Yes</td>
            </tr>
            <tr>
                <td>12/06/19</td>
                <td>Y Liu</td>
                <td>Safety Analyst</td>
                <td>No</td>
            </tr>
            <tr>
                <td>12/20/19</td>
                <td>J Lin</td>
                <td>Developer</td>
                <td>Yes</td>
            </tr>
            <tr>
                <td>12/24/19</td>
                <td>R Metoyer</td>
                <td>Designer</td>
                <td>Yes</td>
            </tr>
            <tr>
                <td>01/02/20</td>
                <td>N Farrell</td>
                <td>Researcher</td>
                <td>No</td>
            </tr>
            <tr>
                <td>01/10/20</td>
                <td>G Rovelli</td>
                <td>Software Engr</td>
                <td>Yes</td>
            </tr>
        </table>
    </div>
    <div style="text-align: center">
        <!--<h6>Do you agree that this is a link?</h6>-->
        <a href="#!" class="modal-close waves-effect waves-green btn-flat">Close</a>
    </div>
</div>

<div id="modal4" class="modal">
    <div class="modal-content">
        <h5 style="text-align: center">Vetting Details</h5>
        <table>
            <tr>
                <th>Date</th>
                <th>Name</th>
                <th>Role</th>
                <th>Link correct?</th>
            </tr>
            <tr>
                <td>11/06/19</td>
                <td>J Cleland-Huang</td>
                <td>Software Engr</td>
                <td>Yes</td>
            </tr>
            <tr>
                <td>01/02/20</td>
                <td>N Farrell</td>
                <td>Researcher</td>
                <td>No</td>
            </tr>
            <tr>
                <td>01/10/20</td>
                <td>G Rovelli</td>
                <td>Software Engr</td>
                <td>Yes</td>
            </tr>
        </table>
    </div>
    <div style="text-align: center">
        <!--<h6>Do you agree that this is a link?</h6>-->
        <a href="#!" class="modal-close waves-effect waves-green btn-flat">Close</a>
    </div>
</div>

<div id="modal5" class="modal">
    <div class="modal-content">
        <h5 style="text-align: center">Vetting Details</h5>
        <table>
            <tr>
                <th>Date</th>
                <th>Name</th>
                <th>Role</th>
                <th>Link correct?</th>
            </tr>
            <tr>
                <td>01/10/20</td>
                <td>G Rovelli</td>
                <td>Software Engr</td>
                <td>Yes</td>
            </tr>
        </table>
    </div>
    <div style="text-align: center">
        <!--<h6>Do you agree that this is a link?</h6>-->
        <a href="#!" class="modal-close waves-effect waves-green btn-flat">Close</a>
    </div>
</div>


<div id="modal6" class="modal">
    <div class="modal-content">
        <h5 style="text-align: center">Vetting Details</h5>
        <table>
            <tr>
                <th>Date</th>
                <th>Name</th>
                <th>Role</th>
                <th>Link correct?</th>
            </tr>
            <tr>
                <td>11/06/19</td>
                <td>J Cleland-Huang</td>
                <td>Software Engr</td>
                <td>Yes</td>
            </tr>

        </table>
    </div>
    <div style="text-align: center">
        <!--<h6>Do you agree that this is a link?</h6>-->
        <a href="#!" class="modal-close waves-effect waves-green btn-flat">Close</a>
    </div>
</div>

<div id="modal7" class="modal">
    <div class="modal-content">
        <h5 style="text-align: center">Vetting Details</h5>
        <table>
            <tr>
                <th>Date</th>
                <th>Name</th>
                <th>Role</th>
                <th>Link correct?</th>
            </tr>
            <tr>
                <td>11/06/19</td>
                <td>J Cleland-Huang</td>
                <td>Software Engr</td>
                <td>Yes</td>
            </tr>
            <tr>
                <td>12/06/19</td>
                <td>Y Liu</td>
                <td>Safety Analyst</td>
                <td>No</td>
            </tr>
        </table>
    </div>
    <div style="text-align: center">
        <!--<h6>Do you agree that this is a link?</h6>-->
        <a href="#!" class="modal-close waves-effect waves-green btn-flat">Close</a>
    </div>
</div>

<div id="modal8" class="modal">
    <div class="modal-content">
        <h5 style="text-align: center">Vetting Details</h5>
        <table>
            <tr>
                <th>Date</th>
                <th>Name</th>
                <th>Role</th>
                <th>Link correct?</th>
            </tr>
            <tr>
                <td>11/06/19</td>
                <td>J Cleland-Huang</td>
                <td>Software Engr</td>
                <td>Yes</td>
            </tr>
            <tr>
                <td>12/06/19</td>
                <td>Y Liu</td>
                <td>Safety Analyst</td>
                <td>No</td>
            </tr>
            <tr>
                <td>12/20/19</td>
                <td>J Lin</td>
                <td>Developer</td>
                <td>Yes</td>
            </tr>
            <tr>
                <td>12/24/19</td>
                <td>R Metoyer</td>
                <td>Designer</td>
                <td>Yes</td>
            </tr>
            <tr>
                <td>01/02/20</td>
                <td>N Farrell</td>
                <td>Researcher</td>
                <td>No</td>
            </tr>
            <tr>
                <td>01/10/20</td>
                <td>G Rovelli</td>
                <td>Software Engr</td>
                <td>Yes</td>
            </tr>
        </table>
    </div>
    <div style="text-align: center">
        <!--<h6>Do you agree that this is a link?</h6>-->
        <a href="#!" class="modal-close waves-effect waves-green btn-flat">Close</a>
    </div>
</div>

</body>



<script src="https://unpkg.com/d3@6.6.1/dist/d3.min.js"></script>
<script>

    var Nodes = [];
    var links = [];
    var lvlCount = 0;
    var numArtifacts = 4;




    var width = Math.round(screen.width * 25 / 100),
        height = 500,
        boxWidth = Math.round(width / 4),
        boxHeight = height/10,
        margin = {
            top: 16,
            right: width/8,
            bottom: 16,
            left: width/20
        },

        gap = {
            width: boxWidth * 2,
            height: 20
        },
        svg;


    var diagonal = d3.linkHorizontal()
        .x(function(d) {
            return d.y;
        })
        .y(function(d) {
            return d.x;
        });

    svg = d3.select("#tree").append("svg")
        .attr("width", width)
        .attr("height", height)
        .append("g");




    // document.addEventListener('DOMContentLoaded', function() {
    //     var elems = document.querySelectorAll('.collapsible');
    //     var instances = M.Collapsible.init(elems);
    // });


    document.addEventListener('DOMContentLoaded', function() {
        var elems = document.querySelectorAll('.modal');

        var instances = M.Modal.init(elems);
        document.body.style.overflow="hidden";
    });




    const colors = d3.scaleOrdinal()
        .range(d3.schemeSet3);



    function ref() {
        location.reload()
        // window.history.back();
    }


    function round(value, precision) {
        var multiplier = Math.pow(10, precision || 0);
        return Math.round(value * multiplier) / multiplier;
    }





    function show_hover(val) {
        console.log(val.score)

    }



    function mouse_action_link(val) {

        var clicked_link = [];

        clicked_link.push(val);

        d3.select("#" + val.id).attr("stroke", "green").attr("stroke-width", "2.5px");

        clicked_link.forEach(function (d) {

            var source_info = d.source;
            var target_info = d.target;


            var highlight_source = d3.select("#" + source_info.id)
                .attr("fill-opacity", "1")
                .attr("stroke", "green")
                .attr("stroke-width", "2.5px");
            ;

            var highlight_target = d3.select("#" + target_info.id)
                .attr("fill-opacity", "1")
                .attr("stroke", "green")
                .attr("stroke-width", "2.5px");
            ;


            var message = "<span style='text-transform: capitalize'>"+ source_info.name +"</span> is a "+
                "<span style='text-transform: uppercase'><b><u>"+ val.relationship +"</u></b></span> " +
                "<span style='text-transform: capitalize'>"+ target_info.name + "</span>";

            hover(message);



            // get all of the class names in the document that has both concepts in the source and target artifacts
            var classNames_s = document.querySelectorAll("[class*=_s]");
            var classNames_t = document.querySelectorAll("[class*=_t]");
            var totalClassNames = [];
            classNames_s.forEach(q=>{
                totalClassNames.push(q.textContent.replace("_s", "").replace(".","").replace(",", ""));
            });
            classNames_t.forEach(q =>{
                totalClassNames.push(q.textContent.replace("_t", "").replace(".","").replace(",", ""));
            });

            var totalClassNames_ = [...new Set(totalClassNames)];
            totalClassNames_.sort();

            var updateStyleSource =  document.getElementsByClassName(source_info.name + "_s");
            for (var i = 0; i < updateStyleSource.length; i++) {
                updateStyleSource[i].style.borderStyle = "solid";
                updateStyleSource[i].style.borderColor = "red";
            }

            for (var j = 0; j < classNames_s.length; j++) {
                var otherclassNamesEach = classNames_s[j].className;
                if (otherclassNamesEach !== source_info.name +"_s"){
                    var extractContent_other_source_classes =  document.getElementsByClassName(otherclassNamesEach);

                    for (var k = 0; k < extractContent_other_source_classes.length; k++) {


                        extractContent_other_source_classes[k].style.backgroundColor = "transparent";

                    }

                }

            }




            var updateStyleTarget =  document.getElementsByClassName(target_info.name + "_t");
            for (var i = 0; i < updateStyleTarget.length; i++) {
                updateStyleTarget[i].style.borderStyle = "solid";
                updateStyleTarget[i].style.borderColor = "red";
            }

            for (var j = 0; j < classNames_t.length; j++) {
                var otherclassNamesEach_t = classNames_t[j].className;
                if (otherclassNamesEach_t !== target_info.name + "_t"){
                    var extractContent_other_target_classes =  document.getElementsByClassName(otherclassNamesEach_t);
                    for (var k = 0; k < extractContent_other_target_classes.length; k++) {


                        extractContent_other_target_classes[k].style.backgroundColor = "transparent";

                    }

                }

            }
        });

    }

    function mouse_action_link_clear(val) {

        var clicked_link = [];

        clicked_link.push(val);

        d3.select("#" + val.id).attr("stroke", "darkgray").attr("stroke-width", "2px");

        clicked_link.forEach(function (d) {

            var source_info = d.source;
            var target_info = d.target;


            var highlight_source = d3.select("#" + source_info.id)
                .attr("fill-opacity", "0.6")
                .attr("stroke", "darkgrey")
                .attr("stroke-width", "2px");
            ;

            var highlight_target = d3.select("#" + target_info.id)
                .attr("fill-opacity", "0.6")
                .attr("stroke", "darkgray")
                .attr("stroke-width", "2px");
            ;

            resetInfoBoardMsg();

            var classNames_s = document.querySelectorAll("[class*=_s]");
            var classNames_t = document.querySelectorAll("[class*=_t]");
            var totalClassNames = [];
            classNames_s.forEach(q=>{
                totalClassNames.push(q.textContent.replace("_s", "").replace(".","").replace(",", ""));
            });
            classNames_t.forEach(q =>{
                totalClassNames.push(q.textContent.replace("_t", "").replace(".","").replace(",", ""));
            });

            var totalClassNames_ = [...new Set(totalClassNames)];
            totalClassNames_.sort();


            var updateStyleSource =  document.getElementsByClassName(source_info.name + "_s");
            for (var i = 0; i < updateStyleSource.length; i++) {
                // updateStyleSource[i].style.fontSize = "1em";
                updateStyleSource[i].style.borderStyle = "none";
            }

            for (var j = 0; j < classNames_s.length; j++) {
                var otherclassNamesEach = classNames_s[j].className;
                if (otherclassNamesEach !== source_info.name +"_s"){
                    var extractContent_other_source_classes =  document.getElementsByClassName(otherclassNamesEach);
                    for (var k = 0; k < extractContent_other_source_classes.length; k++) {


                        extractContent_other_source_classes[k].style.backgroundColor = colors(stemmer(extractContent_other_source_classes[k].textContent.split(" ").join("_").replace(".","").replace(")","")));

                    }

                }

            }


            // var extractContent =  document.getElementsByClassName(val.name+"_s");
            // for (var i = 0; i < extractContent.length; i++) {
            //     extractContent[i].style.borderStyle = "none";
            //
            // }
            //
            // for (var j = 0; j < classNames_s.length; j++) {
            //     var otherclassNamesEach = classNames_s[j].className;;
            //     if (otherclassNamesEach !== val.name + "_s"){
            //         var extractContent_other_source_classes =  document.getElementsByClassName(otherclassNamesEach);
            //         for (var k = 0; k < extractContent_other_source_classes.length; k++) {
            //
            //             extractContent_other_source_classes[k].style.backgroundColor = colors(extractContent_other_source_classes[k].textContent.split(" ").join("_").replace(".","").replace(")",""));
            //         }
            //
            //     }
            //
            // }


            var updateStyleTarget =  document.getElementsByClassName(target_info.name + "_t");
            for (var i = 0; i < updateStyleTarget.length; i++) {
                updateStyleTarget[i].style.borderStyle = "none";
            }

            for (var j = 0; j < classNames_t.length; j++) {
                var otherclassNamesEach_t = classNames_t[j].className;
                if (otherclassNamesEach_t !== target_info.name +"_t"){
                    var extractContent_other_target_classes =  document.getElementsByClassName(otherclassNamesEach_t);
                    for (var k = 0; k < extractContent_other_target_classes.length; k++) {


                        extractContent_other_target_classes[k].style.backgroundColor = colors(stemmer(extractContent_other_target_classes[k].textContent.split(" ").join("_").replace(".","").replace(")","")));

                    }

                }

            }





        });




    }

    function restart() {
        var node = svg.select(".nodes").selectAll("g")
            .data(Nodes);
        node.exit()
            .remove();

        // var colors = d3.scaleOrdinal()
        //     .range(d3.schemeSet3);

        var link = svg.selectAll("path")
            .data(links.splice(0, Nodes.length));

        link.exit()
            .remove();
    }

    function mouse_action(val, stat) {
        "use strict";
        var concept = val.name;
        var concept_type = val.lvl;
        // var all_concepts = [];

        // console.log(val);

        d3.select("#" + val.id)
            .attr("fill", val.cl)
            .attr("fill-opacity", "1")
            .attr("stroke", "green")
            .attr("stroke-width", "2.5px");
        ;



        // var checked_definition = typeof val.definition === 'undefined'? "" : val.definition;

        // console.log(checked_definition);

        if (typeof val.definition === 'undefined'){
            hover("<span style='text-transform: capitalize'><b></b></span>");
        }
        else {
            hover("<span style='text-transform: capitalize'><b>"+ val.name.replaceAll("_", " ") +"</b></span>: "+ val.definition);
        }

        // Update the information panel data with the definition of the concept




        var classNames_s = document.querySelectorAll("[class*=_s]");
        var classNames_t = document.querySelectorAll("[class*=_t]");
        var totalClassNames = [];
        classNames_s.forEach(q=>{
            totalClassNames.push(q.textContent.replace("_s", "").replace(".","").replace(",", ""));
        });
        classNames_t.forEach(q =>{
            totalClassNames.push(q.textContent.replace("_t", "").replace(".","").replace(",", ""));
        });

        var totalClassNames_ = [...new Set(totalClassNames)];
        totalClassNames_.sort();




        // Change the styling of the artifact content based on the concept (node / rect) that the user is hovering on
        if (concept_type===0){
            var extractContent =  document.getElementsByClassName(val.name+"_s");
            // extractContent.style("background-color: pink");
            for (var i = 0; i < extractContent.length; i++) {

                // extractContent[i].style.fontSize = "1.5em";
                extractContent[i].style.borderStyle = "solid";
                extractContent[i].style.borderColor = "red";
            }


            for (var j = 0; j < classNames_s.length; j++) {
                var otherclassNamesEach = classNames_s[j].className;
                // console.log(val.name);
                if (otherclassNamesEach !== val.name+"_s"){
                    var extractContent_other_source_classes =  document.getElementsByClassName(otherclassNamesEach);
                    // console.log(extractContent_other_source_classes)
                    for (var k = 0; k < extractContent_other_source_classes.length; k++) {


                        extractContent_other_source_classes[k].style.backgroundColor = "transparent";

                    }

                }

            }

        }
        else {
            var extractContent =  document.getElementsByClassName(val.name+"_t");

            for (var i = 0; i < extractContent.length; i++) {
                extractContent[i].style.borderStyle = "solid";
                extractContent[i].style.borderColor = "red";
            }


            for (var j = 0; j < classNames_t.length; j++) {
                var otherclassNamesEach_t = classNames_t[j].className;//classNames_t[j].textContent.replace(".","").replace(",", "");
                // console.log(val.name)
                // console.log(classNames_t[j].className);

                // console.log(val.name+"_t", " hey ", classNames_t[j].className);

                if (otherclassNamesEach_t !== val.name+"_t"){
                    // console.log(val.name);
                    var extractContent_other_target_classes =  document.getElementsByClassName(otherclassNamesEach_t);
                    // console.log(extractContent_other_target_classes)
                    for (var k = 0; k < extractContent_other_target_classes.length; k++) {


                        extractContent_other_target_classes[k].style.backgroundColor = "transparent";

                    }

                }

            }


        }


    }

    function mouse_action_clear(val, stat) {
        var concept = val.name;
        var concept_type = val.lvl;
        "use strict";
        d3.select("#" + val.id)
            .attr("fill", val.cl)
            .attr("fill-opacity", "0.6")
            .attr("stroke", "darkgray")
            .attr("stroke-width", "2px");
        // d3.select("#" + val.id).classed("active_d3", stat);
        resetInfoBoardMsg();

        var classNames_s = document.querySelectorAll("[class*=_s]");
        var classNames_t = document.querySelectorAll("[class*=_t]");
        var totalClassNames = [];
        classNames_s.forEach(q=>{
            totalClassNames.push(q.textContent.replace("_s", "").replace(".","").replace(",", ""));
        });
        classNames_t.forEach(q =>{
            totalClassNames.push(q.textContent.replace("_t", "").replace(".","").replace(",", ""));
        });

        var totalClassNames_ = [...new Set(totalClassNames)];
        totalClassNames_.sort();

        if (concept_type===0){
            var extractContent =  document.getElementsByClassName(val.name+"_s");
            for (var i = 0; i < extractContent.length; i++) {
                extractContent[i].style.borderStyle = "none";

            }

            for (var j = 0; j < classNames_s.length; j++) {
                var otherclassNamesEach = classNames_s[j].className;;
                if (otherclassNamesEach !== val.name + "_s"){
                    var extractContent_other_source_classes =  document.getElementsByClassName(otherclassNamesEach);
                    for (var k = 0; k < extractContent_other_source_classes.length; k++) {

                        extractContent_other_source_classes[k].style.backgroundColor = colors(stemmer(extractContent_other_source_classes[k].textContent.split(" ").join("_").replace(".","").replace(")","")));
                    }

                }

            }
        }
        else {
            var extractContent =  document.getElementsByClassName(val.name+"_t");

            for (var i = 0; i < extractContent.length; i++) {
                extractContent[i].style.borderStyle = "none";
            }



            for (var j = 0; j < classNames_t.length; j++) {
                var otherclassNamesEach_t = classNames_t[j].className;//classNames_t[j].textContent.replace(".","").replace(",", "");
                // console.log(val.name)
                // console.log(classNames_t[j].className);

                // console.log(val.name+"_t", " hey ", classNames_t[j].className);

                if (otherclassNamesEach_t !== val.name+"_t"){
                    // console.log(val.name);
                    var extractContent_other_target_classes =  document.getElementsByClassName(otherclassNamesEach_t);
                    // console.log(extractContent_other_target_classes)
                    for (var k = 0; k < extractContent_other_target_classes.length; k++) {


                        extractContent_other_target_classes[k].style.backgroundColor = colors(stemmer(extractContent_other_target_classes[k].textContent.split(" ").join("_").replace(".","").replace(")","")));

                    }

                }

            }


        }


    }

    function resetInfoBoardMsg(){
        document.getElementById('relationship_update').innerHTML = "";
    }



    function drawSource(data){
        Nodes = [];


        var source_data = [data[0].source[0]];



        var artifact_data = {
            "info": []
        };

        var concept_definitions_ = [];
        var source_nodes = [];
        const concept_importance_scores_ = [];

        source_data.forEach(function (d) {
            artifact_data["info"].push({"aid": d["id"], "content": d["text"], "type": d["type"]});


            d['definitions'].forEach(function (k) {
                for (const [key, value] of Object.entries(k)) {
                    concept_definitions_.push({"name": key, "definition": value})
                }
            });



            d["concepts"].forEach(c => {
                source_nodes.push({"lvl": 0, "name": c, "type": "source"});
            });

            d['importance_scores'].forEach(function (k) {
                for (const [key, value] of Object.entries(k)) {
                    concept_importance_scores_.push({"name": key, "imp_score": value})
                }


            });
        });

////






        "use strict";
        var count = [];

        source_nodes.forEach(function (d) {
            count[d.lvl] = 0;
        });

        lvlCount = count.length;

        source_nodes.forEach(function (d, i) {
            if (d.lvl === 0){
                d.x = margin.left + d.lvl * (boxWidth + gap.width);
            }
            else {
                d.x = d.lvl * (boxWidth + gap.width) - margin.right;
            }
            d.y = margin.top + (boxHeight + gap.height) * count[d.lvl];
            d.cl =  colors(stemmer(d.name)); //getUniqueColors(d.name, data_concepts_unique);
            d.definition = conceptDef(d.name, concept_definitions_);
            d.imp_score = conceptImportanceScores(d.name, concept_importance_scores_);
            d.id = "n" + i;
            count[d.lvl] += 1;
            Nodes.push(d);
        });

        // console.log(Nodes);







        // Draw the raw data on the source artifact panel
        document.getElementById("source_artifact").textContent = artifact_data.info[0].content;
        document.getElementById("source_art_name").textContent = "Source " + artifact_data.info[0].aid;

        var str = artifact_data.info[0].type;
        var matches = str.match(/\b(\w)/g); // ['J','S','O','N']
        var acronym = matches.join(''); // JSON
        document.getElementById("source_type").textContent = acronym;
        document.getElementById("source_type_text").textContent = artifact_data.info[0].type;


        var source_concepts = [];

        var importance_scores_source_concepts = [];



        source_data.forEach(function (d) {
            var source_nodes = d['concepts'];
            source_nodes.forEach(c => {
                source_concepts.push(c)
            });

            d['importance_scores'].forEach(function (k) {
                for (const [key, value] of Object.entries(k)) {
                    importance_scores_source_concepts.push({"name": key, "imp_score": value})
                }
            });
        });



        // const data_concepts_unique = [...new Set(source_concepts)];
        // data_concepts_unique.sort();
        // // console.log(data_concepts_unique);
        //
        var s_orig_content = artifact_data['info'][0].content;
        //
        var split_source_words = s_orig_content.split(" ");
        for (var i = 0; i < split_source_words.length; i++) {
            var sourceWord = split_source_words[i].replace(".", "").replace(",","").replace(")","");
            if (source_concepts.includes(sourceWord)) {
                var imp_score_s = conceptImportanceScores(sourceWord, importance_scores_source_concepts);
                // console.log(imp_score_s);
                split_source_words[i] = "<a href='' onmouseout='urlMouseAction_leave(this)' onmouseover='urlMouseAction(this)'><span class='"+sourceWord+"_s' " +
                    "style='font-size:" + (1 * (1 + imp_score_s/ 10)) +"em'>"  +  split_source_words[i].replaceAll("_", " ")  + "</span></a>";


                var new_s = split_source_words.join(" ");

                d3.select("#source_artifact")
                    .html(new_s);
            }



        }

        // d3.select("#source_artifact")
        //             .html(s_orig_content.replaceAll("_", " "));




    }



    function find(text, tp) {
        // "use strict";
        var i;

        for (i = 0; i < Nodes.length; i += 1) {
            if (Nodes[i].type === tp && Nodes[i].name=== text) {
                return Nodes[i];

            }
        }

        return null;
    }



    function urlMouseAction(m){
        var concept = m.text.replace(".", "").replace(",","").replaceAll(" ", "_");
        var definition;



        // console.log(Nodes);
        for (i = 0; i < Nodes.length; i++){
            if (Nodes[i].name === concept){
                definition = Nodes[i].definition;

            }
        }

        // console.log(concept);

        if (typeof definition === 'undefined'){
            hover("<span style='text-transform: capitalize'><b></b></span>");
        }
        else {
            hover("<span style='text-transform: capitalize'><b>"+ concept.replaceAll("_", " ") +"</b></span>: "+ definition);
        }

        // var message = "<span style='text-transform: capitalize'><b>"+ concept +"</b></span>: "+ definition;
        // hover(message);
    }

    function hover(message) {

        document.getElementById('relationship_update').innerHTML = message;
    }

    function urlMouseAction_leave(){


        document.getElementById('relationship_update').innerHTML = "";
    }




    function conceptImportanceScores(val, val_array) {

        for (i= 0; i < val_array.length; i++){
            if (val_array[i].name === val){
                return val_array[i].imp_score;
            }
        }

    }

    function conceptDef(val, val_array) {

        for (var i = 0; i < val_array.length; i++){
            if (val_array[i].name === val){
                return val_array[i].definition;
            }
        }

    }





    function drawTargets(data) {


        var target_data = data[0].targets;

        console.log("Helo1")
        console.log(target_data);
        console.log("Helo")

        var artifact_data = {
            "info": []
        };


        target_data.sort((a, b) => (a.score < b.score) ? 1 : -1)

        target_data.forEach(function (d) {
            artifact_data["info"].push({"aid": d["id"], "content": d["text"],
                "score": round(d["score"], 3), "type": d["type"]});

        });

        // console.log("info", artifact_data);

        // artifact_data['info'].sort((a, b) => (a.score < b.score) ? 1 : -1)

        // console.log(artifact_data);

        var outer_list =  d3.select("#myTable")
            .selectAll("tbody")
            .data(artifact_data['info'])
            .enter()
            .append("tbody")
            .attr("class", "eachTarget_artifact");


        var table_rows = outer_list.append("tr")
            .attr("id", function (d, i) {
                return "row" + (i + 1);
            })
            .attr("class", "collapsible_")
            .style("background-color", "white");

        var table_row_summary = table_rows.append("td");

        var table_row_summary_header_buttons = table_row_summary.append("div");


        var table_row_summary_header_buttons_outerdiv = table_row_summary_header_buttons.append("div")
            .attr("class", "action_btn")
            .style("margin-top", "12px")
            .style("margin-bottom", "12px");

        table_row_summary_header_buttons_outerdiv.append("a")
            .attr("class", "targ_art_name waves-effect waves-light blue-grey lighten-3 dim-grey-text btn-small artifact-type collapsible_new")
            .attr("id", function (d, i) {
                return "row" + (i + 1) + "_target_button"
            })
            .style("color", "black")
            .style("margin-left", "10px")
            .text(function (d) {
                return "Target " + d.aid;
            });

        table_row_summary_header_buttons_outerdiv.append("button")
            .attr("type", "button")
            .attr("class", "btn btn-small score_btn")
            .style("background-color", "white")
            .style("cursor", "unset")
            .style("box-shadow", "none")
            .style("color", "black")
            // .style("margin-left", "1px")
            .html(function (d) {
                return "<b>Score: </b>" + d.score
            });

        table_row_summary_header_buttons_outerdiv.append("button")
            .attr("type", "button")
            .attr("class", "btn btn-small type_btn tooltip_")
            .style("background-color", "white")
            .style("cursor", "unset")
            .style("box-shadow", "none")
            .style("color", "black")
            // .style("margin-left", "1px")
            .html(function (d) {
                var str = d.type;
                var matches = str.match(/\b(\w)/g);
                var acronym = matches.join('');
                return "<b>Type: </b>" + acronym + "<span class='tooltiptext_' style='text-transform: capitalize;'>"+d.type+"</span>";
            });
            // .on("mouseover", function () {
            //     show_hover(d3.select(this).datum());
            // });

        table_row_summary_header_buttons_outerdiv.append("button")
            .attr("type", "button")
            .attr("class", "btn btn-small tooltipped vetting-det modal-trigger vetting_btn")
            .style("box-shadow", "none")
            .attr("id", function (d, i) {
                return "modal" + (i + 1) + "_fire"
            })
            .attr("href", function (d, i) {
                return "#modal" + (i + 1)
            })
            .style("background-color", "white")
            .attr("data-position", "bottom")
            // .style("margin-left", "2px")
            .style("color", "black")
            .attr("data-tooltip", "I am a tooltip")
            .html(function (d) {
                return "5 <i class='material-icons' style='font-size: 1em'>thumb_up</i> 2 <i class='material-icons' style='font-size: 1em'>thumb_down</i>"
            });

        table_row_summary_header_buttons.append("p")
            .attr("class", "art_summary")
            .style("display", "block")
            .style("font-size", "0.9em")
            .style("padding", "10px")
            .style("margin-left", "20px")
            .text(function (d) {
                return d.content.slice(0, 400).replaceAll("_", " ") + "...";
            });


        table_rows.append("td")
            .html(function (d, i) {
                return "<div id='row"+(i+1)+"_vote' style='font-size: 0.8em; display:inline-block; padding:7px;'>\n" +
                    "         <label>\n" +
                    "         <input name='group"+(i+1)+"' type='radio' checked/>\n" +
                    "         <span style='color: black'>Link</span>\n" +
                    "         </label>\n" +
                    "         <label>\n" +
                    "             <input name='group"+(i+1)+"' type='radio'  />\n" +
                    "             <span style='color: black'>No link</span>\n" +
                    "         </label>\n" +
                    "         <label>\n" +
                    "             <input  name='group"+(i+1)+"' type='radio'/>\n" +
                    "             <span style='color: black'>Unvetted</span>\n" +
                    "         </label>\n" +
                    "         </div>"
            });


        var table_rows_content = outer_list.append("tr")
            .attr("class", "collapse-content")
            .attr("id", function (d, i) {
                return "row" + (i + 1) + "_content";
            })
            .style("background-color", "white")
            .style("display", "none");

        table_rows_content.append("td")

        // .attr("colspan", "2")
            .append("div")
            .attr("id", function (d, i) {
                return "row" + (i + 1) + "_content_data";
            })
            .attr("class", "collapsed_content_data")
            .style("display", "none")
            .style("padding", "10px")
            .style("color", "black")
            .style("background-color", "#eceff1")
            .text(function (d) {
                return d.content
            });

        table_rows_content.append("td");

        $(document).ready(function () {
            $('#myTable').pageMe({
                pagerSelector: '#myPager',
                activeColor: 'blue',
                prevText: 'Previous',
                nextText: 'Next',
                showPrevNext: true,
                hidePageNumbers: false,
                perPage: numArtifacts * 2
            });


        });


        // Loading the target data has finished!
        // var coll_ = document.getElementsByClassName("collapsible-header");
        var timesClicked = 0;
        var clicked = false;
        // for (i = 0; i < coll_.length; i++) {
        //     coll_[i].addEventListener("click", collapseFunc);
        //
        //     // coll_[i].addEventListener("click", d);
        // }



        var coll_new = document.getElementsByClassName("collapsible_new");

        // var coll_content = document.getElementsByClassName("collapse-content");

        // for (var i = 0; i < coll_content.length; i++) {
        //     coll_content[i].style.display = "none";
        // }




        for (var i = 0; i < coll_new.length; i++) {
            coll_new[i].addEventListener("click", fnb);
        }

        var back_btn = document.getElementsByClassName("back_button");
        for (var i = 0; i < back_btn.length; i++) {
            back_btn[i].addEventListener("click", ref);
        }



        function fnb() {
            // timesClicked++;

            if (clicked === true) {
                clicked = false;
                // ref();
                ref()

                // var target_this_id_ = this.id.split("_")[0];
                // // console.log(target_this_id);
                //
                // console.log(target_this_id_);
                //
                // var target_this_ = document.getElementsByClassName("active")[0];
                // var content_ = target_this_.nextElementSibling;
                //
                // // console.log(content);
                //
                // var content_data = document.getElementById(content_.id + "_data");
                //
                //
                // content_data.style.display = "none";
                // console.log(target_this_.nextElementSibling);
                // //
                // target_this_.classList.remove("active");
                //
                //
                // var ddd = document.getElementsByClassName("collapsible_");
                //
                //
                // for (var j = 0; j < ddd.length; j++){
                //     ddd[j].id = "row"+(j+1);
                //     ddd[j].style.display="table-row";
                //
                //
                // }
                //
                // // ddd
                //
                //
                //  //
                //  // console.log(currentElemContent);
                //  //
                //  // currentElemContent.style.display = "none";
                //
                //
                //
                //
                //
                // $(document).ready(function () {
                //     $('#myTable').pageMe({
                //         pagerSelector: '#myPager',
                //         activeColor: 'blue',
                //         prevText: 'Previous',
                //         nextText: 'Next',
                //         showPrevNext: true,
                //         hidePageNumbers: false,
                //         perPage: numArtifacts * 2
                //     });
                //
                //
                // });


            }
            else {

                // console.log(this.id);
                var target_this_id = this.id.split("_")[0];
                // console.log(target_this_id);

                var target_this = document.getElementById(target_this_id);
                // var main_parent =


                target_this.classList.toggle("active");


                // for (var i = 0; i < coll_content.length; i++) {
                //     coll_content[i].style.display = "table-row";
                // }

                //

                var active_class = document.getElementsByClassName("active");
                var index_of_current_target;

                // console.log(document.getElementById(this.nextElementSibling.id + "_data").style.display);

                // var all_collapse_content = document.sel


                for (var q = 0; q < coll_new.length; q++) {
                    var current_q_id = coll_new[q].id.split("_")[0];
                    var current_q = document.getElementById(current_q_id);
                    if (current_q === target_this) {
                        index_of_current_target = q;

                        // console.log(index_of_current_target);


                        var content = target_this.nextElementSibling;

                        console.log(content);

                        var content_data = document.getElementById(content.id + "_data");
                        // console.log(content_data.style.display);
                        //
                        //
                        current_q.setAttribute("id", "currently_clicked_target");
                        // content_data.setAttribute("id", "currently_clicked_target_content");

                        //
                        if (content_data.style.display === "block") {
                            console.log("It is closed right now");
                            content_data.style.display = "none";


                            //
                            //
                        }
                        else {
                            content_data.style.display = "block";

                            console.log("It is open right now");
                            current_q.getElementsByClassName("art_summary")[0].style.display = "none"
                            // coll_2[q].classList.remove("collapsible_");


                        }
                    }
                    else { // while the collapsibles are not active, make sure to show their summary

                        current_q.classList.remove("active");
                        // coll_2[q].classList.remove("collapsible_");
                        current_q.style.display = "none";
                        current_q.setAttribute("id", "");
                        // current_q.nextElementSibling.setAttribute("id", "");
                        current_q.nextElementSibling.style.display = "none";
                        // current_q.classList.add("unopened")


                    }

                }




                document.getElementById("pagination_panel").style.display="none";
                clicked = true;



                var t_orig_content = document.getElementById("row" + (index_of_current_target + 1) + "_content_data").textContent;

                var target_concepts = [];

                var importance_scores_target_concepts = [];
                var clickedTargetData = [];
                clickedTargetData.push(target_data[index_of_current_target]);

                clickedTargetData.forEach(function (d) {
                    var target_nodes = d['concepts'];
                    target_nodes.forEach(c => {
                        target_concepts.push(c)
                    });

                    d['importance_scores'].forEach(function (k) {
                        for (const [key, value] of Object.entries(k)) {
                            importance_scores_target_concepts.push({"name": key, "imp_score": value})
                        }
                    });
                });

                // console.log(clickedTargetData[0].score)

                //Highlight the important words in the clicked target artifact
                var split_target_words = t_orig_content.split(" ");
                for (var i = 0; i < split_target_words.length; i++) {
                    var targetWord = split_target_words[i].replace(".", "").replace(",", "").replace(")", "");
                    if (target_concepts.includes(targetWord)) {
                        var imp_score_t = conceptImportanceScores(targetWord, importance_scores_target_concepts);
                        // console.log(imp_score_s);
                        split_target_words[i] = "<a href='' onmouseout='urlMouseAction_leave(this)' onmouseover='urlMouseAction(this)'><span class='" + targetWord + "_t' " +
                            "style='background-color:" + colors(stemmer(targetWord)) + ";font-size:" + (1 * (1 + imp_score_t / 10)) + "em'>" + split_target_words[i].replaceAll("_", " ") + "</span></a>";


                        var new_t = split_target_words.join(" ");

                        d3.select("#" + "row" + (index_of_current_target + 1) + "_content_data")
                            .html(new_t);
                    }


                }


                //Highlight the important words in the source artifact
                var source_data = [data[0].source[0]];
                var source_concepts = [];

                var importance_scores_source_concepts = [];



                source_data.forEach(function (d) {
                    var source_nodes = d['concepts'];
                    source_nodes.forEach(c => {
                        source_concepts.push(c)
                    });

                    d['importance_scores'].forEach(function (k) {
                        for (const [key, value] of Object.entries(k)) {
                            importance_scores_source_concepts.push({"name": key, "imp_score": value})
                        }
                    });
                });




                // console.log(source_data);
                var s_orig_content = source_data[0].text;

                var split_source_words = s_orig_content.split(" ");
                for (var i = 0; i < split_source_words.length; i++) {
                    var sourceWord = split_source_words[i].replace(".", "").replace(",","").replace(")","");
                    // console.log(sourceWord)
                    if (source_concepts.includes(sourceWord)) {
                        var imp_score_s = conceptImportanceScores(sourceWord, importance_scores_source_concepts);
                        // console.log(imp_score_s);
                        split_source_words[i] = "<a href='' onmouseout='urlMouseAction_leave(this)' onmouseover='urlMouseAction(this)'><span class='"+sourceWord+"_s' " +
                            "style='background-color:"+ colors(stemmer(sourceWord)) + ";font-size:" + (1 * (1 + imp_score_s/ 10)) +"em'>"  +  split_source_words[i].replaceAll("_", " ")  + "</span></a>";


                        var new_s = split_source_words.join(" ");

                        d3.select("#source_artifact")
                            .html(new_s);
                    }



                }






                // This is the point where we will set the function that will draw the link between the source and the current target
                var data_node_links_ = {
                    "Nodes": [],
                    "links": []
                };


                var source_data = data[0].source;
                var all_data_concepts_ = [];

                source_data.forEach(function (d) {
                    var source_nodes = d['concepts'];
                    source_nodes.forEach(c => {
                        data_node_links_["Nodes"].push({"lvl": 0, "name": c, "type": "source"});
                        all_data_concepts_.push(c)
                    });

                });


                clickedTargetData.forEach(function (d) {
                    var target_nodes = d['concepts'];
                    target_nodes.forEach(c => {
                        data_node_links_["Nodes"].push({"lvl": 1, "name": c, "type": "target"});
                        all_data_concepts_.push(c)
                    });
                    d['links'].forEach(l => {
                        data_node_links_["links"].push(l);
                    })

                });


                const all_unique_concepts = [...new Set(all_data_concepts_)];
                all_unique_concepts.sort();


                const concept_definitions_ = [];
                const concept_importance_scores_ = [];

                source_data.forEach(function (d) {
                    var terminology = d["terminilogy"];
                    d['definitions'].forEach(function (k) {
                        for (const [key, value] of Object.entries(k)) {
                            concept_definitions_.push({"name": key, "definition": value})
                        }
                    });

                    d['importance_scores'].forEach(function (k) {
                        for (const [key, value] of Object.entries(k)) {
                            concept_importance_scores_.push({"name": key, "imp_score": value});

                        }

                    });


                });

                clickedTargetData.forEach(function (d) {
                    d['definitions'].forEach(function (k) {
                        for (const [key, value] of Object.entries(k)) {
                            concept_definitions_.push({"name": key, "definition": value})
                        }
                    });

                    d['importance_scores'].forEach(function (k) {
                        for (const [key, value] of Object.entries(k)) {
                            concept_importance_scores_.push({"name": key, "imp_score": value})
                        }

                    });

                });

                "use strict";
                var count = [];

                data_node_links_.Nodes.forEach(function (d) {
                    count[d.lvl] = 0;
                });

                lvlCount = count.length;

                Nodes = [];
                data_node_links_.Nodes.forEach(function (d, i) {
                    // console.log(i);
                    if (d.lvl === 0) {
                        d.x = margin.left + d.lvl * (boxWidth + gap.width);
                    }
                    else {
                        d.x = d.lvl * (boxWidth + gap.width) - margin.right;
                    }
                    d.y = margin.top + (boxHeight + gap.height) * count[d.lvl];
                    d.cl = colors(stemmer(d.name)); //getUniqueColors(d.name, data_concepts_unique);
                    d.definition = conceptDef(d.name, concept_definitions_);
                    d.imp_score = conceptImportanceScores(d.name, concept_importance_scores_);
                    d.id = "n" + i;
                    count[d.lvl] += 1;
                    Nodes.push(d);
                    // plc_Nodes.push(d);
                });


//     // get details about the links and how to draw the path between them
                links = [];
                data_node_links_.links.forEach(function (d) {
                    // links = [];
                    links.push({
                        source: find(d.source, "source"),
                        target: find(d.target, "target"),

                        id: "l" + find(d.source, "source").id + find(d.target, "target").id,
                        relationship: d.relationship
                    });
                });

                // console.log(links);
                // console.log("jj")

                var useful_link = links;
                // console.log();

                // Draw all of the nodes
                svg.append("g")
                    .attr("class", "nodes");

                var node = svg.select(".nodes")
                    .selectAll("g")
                    .data(Nodes)
                    .enter()
                    .append("g")
                    .attr("class", "unit");

                node.append("rect")
                    .attr("x", function (d) {
                        return d.x;
                    })
                    .attr("y", function (d) {
                        return d.y;
                    })
                    .attr("id", function (d) {
                        return d.id;
                    })
                    .attr("width", boxWidth)
                    .attr("height", boxHeight)
                    .attr("class", "node")
                    .attr("fill", function (d) {
                        return colors(stemmer(d.name));//getUniqueColors(d.name, data_concepts_unique); // in case we want the color to change based on the color of the text
                    })
                    .attr("fill-opacity", "0.5")
                    .attr("stroke", "darkgrey")
                    .attr("stroke-width", "2px")
                    // // .attr("fill", "blue")
                    .on("mouseover", function () {
                        mouse_action(d3.select(this).datum(), true);
                    })
                    .on("mouseout", function () {
                        mouse_action_clear(d3.select(this).datum(), false);
                    });


                // Add the text to display in the rect (i.e., each node)
                node.append("text")
                    .attr("class", "label")
                    .attr("x", function (d) {
                        return d.x + boxWidth / 8;
                    })
                    .attr("y", function (d) {
                        return d.y + boxHeight / 1.7;
                    })
                    .text(function (d) {
                        return d.name.replaceAll("_", " ");
                    })
                    .attr("font-size", (boxWidth * 0.007) + "em");


                links.forEach(function (li) {
                    svg.append("path", "g")
                        .attr("class", "link_d3")
                        .attr("stroke", "darkgray")
                        // .style("stroke-dasharray", ("3, 3"))
                        .attr("id", li.id)
                        .attr("d", function () {
                            var oTarget = {

                                x: li.target.y + 0.5 * boxHeight,
                                y: li.target.x
                            };
                            var oSource = {
                                x: li.source.y + 0.5 * boxHeight,
                                y: li.source.x
                            };

                            if (oSource.y < oTarget.y) {
                                oSource.y += boxWidth;
                            } else {
                                oTarget.y += boxWidth;
                            }
                            return diagonal({
                                source: oSource,
                                target: oTarget
                            });
                        })
                        // .attr("stroke-width", "black")
                        .on("mouseover", function () {
                            mouse_action_link(li);
                        })
                        .on("mouseout", function () {
                            mouse_action_link_clear(li)
                        });
                });


            }
        }







    }


    var stemmer = (function(){
        var step2list = {
                "ational" : "ate",
                "tional" : "tion",
                "enci" : "ence",
                "anci" : "ance",
                "izer" : "ize",
                "bli" : "ble",
                "alli" : "al",
                "entli" : "ent",
                "eli" : "e",
                "ousli" : "ous",
                "ization" : "ize",
                "ation" : "ate",
                "ator" : "ate",
                "alism" : "al",
                "iveness" : "ive",
                "fulness" : "ful",
                "ousness" : "ous",
                "aliti" : "al",
                "iviti" : "ive",
                "biliti" : "ble",
                "logi" : "log"
            },

            step3list = {
                "icate" : "ic",
                "ative" : "",
                "alize" : "al",
                "iciti" : "ic",
                "ical" : "ic",
                "ful" : "",
                "ness" : ""
            },

            c = "[^aeiou]",          // consonant
            v = "[aeiouy]",          // vowel
            C = c + "[^aeiouy]*",    // consonant sequence
            V = v + "[aeiou]*",      // vowel sequence

            mgr0 = "^(" + C + ")?" + V + C,               // [C]VC... is m>0
            meq1 = "^(" + C + ")?" + V + C + "(" + V + ")?$",  // [C]VC[V] is m=1
            mgr1 = "^(" + C + ")?" + V + C + V + C,       // [C]VCVC... is m>1
            s_v = "^(" + C + ")?" + v;                   // vowel in stem

        function dummyDebug() {}

        function realDebug() {
            console.log(Array.prototype.slice.call(arguments).join(' '));
        }

        return function (w, debug) {
            var
                stem,
                suffix,
                firstch,
                re,
                re2,
                re3,
                re4,
                debugFunction,
                origword = w;

            if (debug) {
                debugFunction = realDebug;
            } else {
                debugFunction = dummyDebug;
            }

            if (w.length < 3) { return w; }

            firstch = w.substr(0,1);
            if (firstch == "y") {
                w = firstch.toUpperCase() + w.substr(1);
            }

            // Step 1a
            re = /^(.+?)(ss|i)es$/;
            re2 = /^(.+?)([^s])s$/;

            if (re.test(w)) {
                w = w.replace(re,"$1$2");
                debugFunction('1a',re, w);

            } else if (re2.test(w)) {
                w = w.replace(re2,"$1$2");
                debugFunction('1a',re2, w);
            }

            // Step 1b
            re = /^(.+?)eed$/;
            re2 = /^(.+?)(ed|ing)$/;
            if (re.test(w)) {
                var fp = re.exec(w);
                re = new RegExp(mgr0);
                if (re.test(fp[1])) {
                    re = /.$/;
                    w = w.replace(re,"");
                    debugFunction('1b',re, w);
                }
            } else if (re2.test(w)) {
                var fp = re2.exec(w);
                stem = fp[1];
                re2 = new RegExp(s_v);
                if (re2.test(stem)) {
                    w = stem;
                    debugFunction('1b', re2, w);

                    re2 = /(at|bl|iz)$/;
                    re3 = new RegExp("([^aeiouylsz])\\1$");
                    re4 = new RegExp("^" + C + v + "[^aeiouwxy]$");

                    if (re2.test(w)) {
                        w = w + "e";
                        debugFunction('1b', re2, w);

                    } else if (re3.test(w)) {
                        re = /.$/;
                        w = w.replace(re,"");
                        debugFunction('1b', re3, w);

                    } else if (re4.test(w)) {
                        w = w + "e";
                        debugFunction('1b', re4, w);
                    }
                }
            }

            // Step 1c
            re = new RegExp("^(.*" + v + ".*)y$");
            if (re.test(w)) {
                var fp = re.exec(w);
                stem = fp[1];
                w = stem + "i";
                debugFunction('1c', re, w);
            }

            // Step 2
            re = /^(.+?)(ational|tional|enci|anci|izer|bli|alli|entli|eli|ousli|ization|ation|ator|alism|iveness|fulness|ousness|aliti|iviti|biliti|logi)$/;
            if (re.test(w)) {
                var fp = re.exec(w);
                stem = fp[1];
                suffix = fp[2];
                re = new RegExp(mgr0);
                if (re.test(stem)) {
                    w = stem + step2list[suffix];
                    debugFunction('2', re, w);
                }
            }

            // Step 3
            re = /^(.+?)(icate|ative|alize|iciti|ical|ful|ness)$/;
            if (re.test(w)) {
                var fp = re.exec(w);
                stem = fp[1];
                suffix = fp[2];
                re = new RegExp(mgr0);
                if (re.test(stem)) {
                    w = stem + step3list[suffix];
                    debugFunction('3', re, w);
                }
            }

            // Step 4
            re = /^(.+?)(al|ance|ence|er|ic|able|ible|ant|ement|ment|ent|ou|ism|ate|iti|ous|ive|ize)$/;
            re2 = /^(.+?)(s|t)(ion)$/;
            if (re.test(w)) {
                var fp = re.exec(w);
                stem = fp[1];
                re = new RegExp(mgr1);
                if (re.test(stem)) {
                    w = stem;
                    debugFunction('4', re, w);
                }
            } else if (re2.test(w)) {
                var fp = re2.exec(w);
                stem = fp[1] + fp[2];
                re2 = new RegExp(mgr1);
                if (re2.test(stem)) {
                    w = stem;
                    debugFunction('4', re2, w);
                }
            }

            // Step 5
            re = /^(.+?)e$/;
            if (re.test(w)) {
                var fp = re.exec(w);
                stem = fp[1];
                re = new RegExp(mgr1);
                re2 = new RegExp(meq1);
                re3 = new RegExp("^" + C + v + "[^aeiouwxy]$");
                if (re.test(stem) || (re2.test(stem) && !(re3.test(stem)))) {
                    w = stem;
                    debugFunction('5', re, re2, re3, w);
                }
            }

            re = /ll$/;
            re2 = new RegExp(mgr1);
            if (re.test(w) && re2.test(w)) {
                re = /.$/;
                w = w.replace(re,"");
                debugFunction('5', re, re2, w);
            }

            // and turn initial Y back to y
            if (firstch == "y") {
                w = firstch.toLowerCase() + w.substr(1);
            }


            return w;
        }
    })();








    d3.json("annotated_link_v2.json").then(data => {
        drawTargets(data);
        drawSource(data);



    });




</script>
</html>